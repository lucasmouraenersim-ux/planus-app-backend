
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Tempo Severo no Hemisf√©rio Sul</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- ArcGIS API CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/3.35/esri/css/esri.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.35/dijit/themes/claro/claro.css">

  <style>
    html, body, #outerPane {
      width:100%; height:100%; margin:0; padding:0;
    }
    #outerPane { position:relative; }
    
    #mapDiv {
      position:absolute; top:60px; right:0; bottom:0; left:0;
    }

    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #003366; color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px; z-index: 9999;
    }
    #topbar .left { display: flex; align-items: center; gap: 10px; }
    #topbar .left img { height: 30px; }
    #topbar .left h1 { font-size: 18px; margin: 0; }
    #topbar input[type="text"] {
      padding: 6px; font-size: 14px; width: 250px;
    }
    #topbar .right { display: flex; align-items: center; gap: 8px; }
    .top-btn {
      background: none; border: none; color: white;
      font-size: 20px; cursor: pointer; padding: 4px;
    }
    .top-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    .date-controls {
      display: flex; align-items: center; gap: 4px;
    }
    .date-controls input[type="date"] {
      padding: 3px 6px; font-size: 13px;
    }
    .date-controls .date-btn {
      background: #0066cc; color: white; border: none;
      padding: 4px 8px; font-size: 13px; border-radius: 3px;
      cursor: pointer;
    }

    #customTools {
      position: fixed;
      top: 150px;
      left: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #customTools button {
      width: 32px;
      height: 32px;
      background: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      box-shadow: 0 0 3px rgba(0,0,0,0.2);
    }
    #customTools button:hover {
      background: #eee;
    }

    /* Modal Forecast */
    #forecastModal {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:300px; background:#fff;
      padding:20px;
      border:1px solid #ccc;
      border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      z-index:99999;
      font-family:sans-serif;
    }
    #forecastModal h3 { margin-top:0; }
    #forecastModal select {
      width: 100%;
      padding: 6px;
      margin-top: 8px;
    }
    #forecastModal button {
      margin-top: 12px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #forecastModal .cancel { background: #ccc; }
    #forecastModal .save { background: #0066cc; color: white; margin-left: 10px; }

    /* Modal de Coordenadas */
    #coordModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 10000;
      width: 300px;
    }
    #coordModal input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #coordModal button {
      margin-top: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #coordModal .save {
      background: #0066cc;
      color: white;
    }
    #coordModal .cancel {
      background: #ccc;
      margin-right: 10px;
    }
    
    /* Controles de Overlay DIN√ÇMICO */
    #overlayControls {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(255,255,255,0.95);
      color: #333;
      padding: 12px;
      border-radius: 6px;
      z-index: 9998;
      font-size: 13px;
      font-family: sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border: 1px solid #ccc;
      display: none; /* Escondido por padr√£o */
    }
    #overlayControls b {
        display: block;
        margin-bottom: 10px;
        font-size: 16px;
        color: #003366;
    }
    #overlayControls label {
        display: block;
        margin-bottom: 8px;
    }
    #overlayControls input[type="range"] {
      width: 100px;
      margin-top: 5px;
    }

    .radar-controls {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .radar-controls h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #1f4059;
    }
    .radar-controls h5 {
      margin: 8px 0 5px 0;
      font-size: 13px;
      font-weight: bold;
    }
    .radar-group {
      margin-bottom: 10px;
    }
    .radar-group label {
      display: inline-block;
      margin-right: 15px;
      font-size: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-spinner-bars {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
    }
    .loading-spinner-bars div {
        width: 6px;
        margin: 0 3px;
        background-color: white;
        animation: bar-pulse 1.2s infinite ease-in-out;
    }
    .loading-spinner-bars div:nth-child(1) { height: 20px; animation-delay: -0.4s; }
    .loading-spinner-bars div:nth-child(2) { height: 30px; animation-delay: -0.2s; }
    .loading-spinner-bars div:nth-child(3) { height: 40px; animation-delay: 0s; }
    .loading-spinner-bars div:nth-child(4) { height: 30px; animation-delay: 0.2s; }
    .loading-spinner-bars div:nth-child(5) { height: 20px; animation-delay: 0.4s; }

    @keyframes bar-pulse {
        0%, 80%, 100% { transform: scaleY(0.4); }
        40% { transform: scaleY(1.0); }
    }

    /* Estilo para tela cheia */
    :fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      background: white;
    }
    /* Suporte para diferentes navegadores */
    :-webkit-full-screen, :-moz-full-screen, :-ms-fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      background: white;
    }
  </style>

  <!-- ArcGIS API -->
  <script src="https://js.arcgis.com/3.35/"></script>
</head>

<body class="claro">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #4A90E2; display: flex; justify-content: center; align-items: center; z-index: 99999;">
      <div style="text-align: center;">
          <div class="loading-spinner-bars">
            <div></div><div></div><div></div><div></div><div></div>
          </div>
      </div>
  </div>

  <script>
    // Fun√ß√£o para for√ßar tela cheia
    function forceFullscreen() {
        const elem = document.documentElement;
        try {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            }
        } catch (err) {
            console.warn("‚ö†Ô∏è N√£o foi poss√≠vel ativar tela cheia:", err);
        }
    }

    // Controle do loading
    window.addEventListener('load', function() {
        setTimeout(function() {
            var loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.opacity = '0';
            loadingOverlay.style.transition = 'opacity 1s';
            setTimeout(function() {
                loadingOverlay.style.display = 'none';
            }, 1000);
        }, 1000); // 1 segundo
    });
  </script>

  <!-- Input de arquivo (movido para o in√≠cio do body) -->
  <input type="file" id="geoImageInput" accept=".jpg,.jpeg,.png,.tif,.tiff" style="display:none">

  <!-- Topbar NOAA -->
  <div id="topbar">
    <div class="left">
      <h1>Tempo Severo no Hemisf√©rio Sul</h1>
      <input type="text" id="searchInput" placeholder="Find address or place..." />
    </div>

    <div id="riskControls" style="
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 9999;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    ">
      <label>
        Tipo:
        <select id="hazardSel">
          <option value="hail">Granizo</option>
          <option value="wind">Vento</option>
          <option value="tornado">Tornado</option>
        </select>
      </label>

      <label>
        Prob(%):
        <select id="probSel"></select>
      </label>

      <label style="display: flex; align-items: center; gap: 4px;">
        <input type="checkbox" id="chkForecastView">
        <span>Ver previs√£o feita</span>
      </label>
    </div>

    <div class="right">
      <button class="top-btn" title="Filtro">üîç</button>
      <button class="top-btn" title="Adicionar Dados">‚ûï</button>
      <button class="top-btn" id="toggleOverlaysBtn" title="Sobreposi√ß√µes">üìö</button>
      <button class="top-btn" title="Legenda">üìã</button>
      <button class="top-btn" title="Resultados">üìë</button>
      <button class="top-btn" title="Informa√ß√µes">‚ÑπÔ∏è</button>
      <button class="top-btn" onclick="resetMap()" title="Reset View">üîÑ</button>
      <button class="top-btn" onclick="triggerImageUpload()" title="Carregar Imagem">üñºÔ∏è</button>
      <button class="date-btn" id="btnSubmitForecast">Enviar previs√£o</button>
      <div class="date-controls">
        <label>De: <input type="date" id="startDate" /></label>
        <label>At√©: <input type="date" id="endDate" /></label>
        <button class="date-btn" id="submitDate">Buscar</button>
        <button class="date-btn">Resetar</button>
      </div>
    </div>
  </div>

  <!-- Bot√µes flutuantes -->
  <div id="customTools">
    <button onclick="toggleFullscreen()" title="Tela Cheia">‚õ∂</button>
    <button onclick="activatePolygonDraw()" title="Desenhar Pol√≠gono">‚¨¢</button>
  </div>

  <!-- Painel lateral removido -->
  <div id="outerPane">
    <div id="mapDiv"></div>
  </div>

  <div id="hudOverlay" style="
    position: fixed;
    bottom: 8px;
    left: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    font-family: monospace;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 9999;
    pointer-events: none;
  ">
    üìç --,-- ¬∞
  </div>

  <!-- Painel de Estat√≠sticas -->
  <div id="statsPanel" style="
    position: fixed;
    bottom: 180px;
    right: 20px;
    background: rgba(255,255,255,0.95);
    padding: 10px 14px;
    font-size: 13px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-family: sans-serif;
    z-index: 9999;
  ">
    <div id="statsContent">Carregando...</div>
  </div>

  <!-- Controles de Overlay DIN√ÇMICO -->
  <div id="overlayControls">
    <b>Sobreposi√ß√µes</b>
    <label><input type="checkbox" id="toggleRainviewer"> Radar (RainViewer)</label>
    <label><input type="checkbox" id="toggleMunicipios"> Munic√≠pios</label>
    
    <div id="imageControls" style="display: none;">
      <label><input type="checkbox" id="toggleOverlay"> Mostrar Imagem</label>
      <div id="opacityControl" style="margin-left: 20px; display: none;">
        Opacidade: <span id="opacityValue">100%</span><br>
        <input type="range" id="opacitySlider" min="0" max="100" value="100" style="width: 100%;">
      </div>
    </div>
    
    <!-- Controles do CPTEC ser√£o inseridos aqui via JS -->
  </div>


  <!-- Modal para salvar previs√£o -->
  <div id="forecastModal">
    <h3>Salvar Previs√£o</h3>
    <label>Dia:
      <select id="dayType">
        <option value="hoje">Hoje</option>
        <option value="amanh√£">Amanh√£</option>
      </select>
    </label>
    <br><br>
    <button class="cancel" onclick="cancelForecast()">Cancelar</button>
    <button class="save" onclick="confirmForecast()">Salvar</button>
  </div>

  <!-- Modal de escolha -->
  <div id="choiceDlg" style="
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #262626;
    color: white;
    border: 1px solid #999;
    border-radius: 6px;
    padding: 16px 20px;
    font-family: sans-serif;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    z-index: 10000;
  ">
    <div style="margin-bottom: 10px">O que deseja visualizar?</div>
    <button onclick="setForecastView('all')">Todos os riscos</button>
    <button onclick="setForecastView('overall')">Mapa geral</button>
  </div>

  <!-- Modal de Coordenadas -->
  <div id="coordModal" style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 10000;
    width: 300px;
  ">
    <h3>Coordenadas da Imagem</h3>
    <div style="margin-bottom: 15px;">
      <button id="btnAutoLoad" class="auto-load" style="width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">
        Carregar Automaticamente
      </button>
      <div style="text-align: center; color: #666; margin: 5px 0;">- ou -</div>
      <div style="text-align: center; color: #666; font-size: 12px;">Ajuste as coordenadas manualmente:</div>
    </div>
    <label>Longitude M√≠nima (Oeste):<br>
      <input type="number" id="lonMin" step="0.000001" value="-60.503571">
    </label><br>
    <label>Longitude M√°xima (Leste):<br>
      <input type="number" id="lonMax" step="0.000001" value="-38.495731">
    </label><br>
    <label>Latitude M√≠nima (Sul):<br>
      <input type="number" id="latMin" step="0.000001" value="-33.002845">
    </label><br>
    <label>Latitude M√°xima (Norte):<br>
      <input type="number" id="latMax" step="0.000001" value="-16.497153">
    </label><br>
    <button id="btnCancelLoad" class="cancel">Cancelar</button>
    <button id="btnLoadCoords" class="save">Carregar Manual</button>
  </div>

  <script>
  let forecastGraphics = [];
  let forecastMode = "all"; // "all" ou "overall"
  let brazilBoundary = null;
  let brazilBoundaryReady = false;

  let currentUser = null;

  // üîí Escuta login enviado pelo Wix
  window.addEventListener("message", (e) => {
    const msg = e.data;

    try {
      const parsed = typeof msg === "string" ? JSON.parse(msg) : msg;

      if (parsed?.loggedIn) {
        currentUser = {
          email: parsed.email,
          nick: parsed.nick || parsed.email?.split("@")[0],
          memberId: parsed.memberId || null
        };
        console.log("‚úÖ Usu√°rio logado:", currentUser);
      }
    } catch (err) {
      //console.warn("üîÅ Mensagem n√£o era JSON parse√°vel:", err);
    }
  });

  // üïí Se n√£o houver login ap√≥s 3s, assume an√¥nimo
  setTimeout(() => {
    if (!currentUser) {
      currentUser = {
        email: "anon@local",
        nick: "visitante",
        memberId: null
      };
      console.warn("‚ö†Ô∏è Modo visitante");
    }
  }, 3000);

  function triggerImageUpload() {
    console.log("üñºÔ∏è Bot√£o de upload clicado");
    const input = document.getElementById("geoImageInput");
    const modal = document.getElementById("coordModal");
    
    console.log("üîç Verificando elementos:", { 
      input: !!input, 
      modal: !!modal 
    });
    
    if (!input) {
      console.error("‚ùå Input de arquivo n√£o encontrado!");
      return;
    }
    
    if (!input.hasEventListener) {
      console.log("‚öôÔ∏è Adicionando handler ao input...");
      input.addEventListener("change", handleFileSelect);
      input.hasEventListener = true;
    }
    
    input.click();
    console.log("‚úÖ Input de arquivo acionado");
  }
  
  function handleFileSelect(e) {
    console.log("üìÅ Handler de arquivo chamado");
    const file = e.target.files[0];
    if (!file) {
      console.warn("‚ö†Ô∏è Nenhum arquivo selecionado");
      return;
    }

    console.log("üìÑ Arquivo selecionado:", file.name);

    // Verifica o tipo do arquivo
    const validTypes = ['image/jpeg', 'image/png', 'image/tiff'];
    if (!validTypes.includes(file.type)) {
      alert("Por favor, selecione uma imagem nos formatos: JPG, PNG ou TIFF");
      return;
    }

    const reader = new FileReader();
    
    reader.onload = function(evt) {
      console.log("üì∑ Imagem carregada no FileReader");
      window.currentImageURL = evt.target.result;
      
      const modal = document.getElementById("coordModal");
      console.log("üîç Procurando modal:", !!modal);
      
      if (!modal) {
        console.error("‚ùå Modal n√£o encontrado!");
        return;
      }
      
      modal.style.display = "block";
      console.log("‚úÖ Modal exibido");
      
      // Garante que os bot√µes est√£o configurados
      initModalButtons();
    };

    reader.onerror = function(evt) {
      console.error("‚ùå Erro ao ler arquivo:", evt.target.error);
      alert("Erro ao ler o arquivo. Por favor, tente novamente.");
    };

    console.log("üìñ Iniciando leitura do arquivo...");
    reader.readAsDataURL(file);
  }

  require([
    "esri/map",
    "esri/geometry/Polygon",
    "esri/geometry/webMercatorUtils",
    "esri/geometry/Extent",
    "esri/dijit/HomeButton",
    "esri/layers/WebTiledLayer",
    "esri/layers/WMSLayer",
    "esri/layers/TiledMapServiceLayer",
    "esri/toolbars/edit",
    "esri/dijit/Print",
    "esri/dijit/Legend",
    "esri/dijit/BasemapGallery",
    "esri/dijit/OverviewMap",
    "esri/dijit/TimeSlider",
    "esri/dijit/Scalebar",
    "esri/layers/ArcGISDynamicMapServiceLayer",
    "esri/geometry/Point",
    "esri/SpatialReference",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/symbols/SimpleLineSymbol",
    "esri/symbols/SimpleFillSymbol",
    "esri/Color",
    "esri/graphic",
    "esri/toolbars/draw",
    "esri/layers/MapImage",
    "esri/layers/MapImageLayer",
    "esri/config",
    "dojo/dom",
    "dojo/on",
    "dojo/dom-construct",
    "dojo/_base/declare",
    "dojo/domReady!"
  ], function(
    Map, Polygon, webMercatorUtils, Extent, HomeButton, WebTiledLayer, WMSLayer,
    TiledMapServiceLayer, edit, Print, Legend, BasemapGallery, OverviewMap, TimeSlider,
    Scalebar, ArcGISDynamicMapServiceLayer, Point, SpatialReference,
    SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,
    Color, Graphic, Draw, MapImage, MapImageLayer, esriConfig,
    dom, on, domConstruct, declare
  ) {
    // Configura√ß√£o CORS e seguran√ßa
    esriConfig.defaults.io.corsEnabledServers.push(
      "radar.cptec.inpe.br",
      "http://radar.cptec.inpe.br",
      "https://radar.cptec.inpe.br"
    );
    
    // Desativa uso de proxy e CORS
    esriConfig.defaults.io.alwaysUseProxy = false;
    esriConfig.defaults.io.corsDetection = false;
    esriConfig.defaults.io.useCors = false;
    
    // Permite requisi√ß√µes mistas (HTTP/HTTPS)
    esriConfig.defaults.io.postMixInProperties = function() {
      this.protocol = window.location.protocol;
    };
    
    // Configura timeout mais longo para requisi√ß√µes
    esriConfig.defaults.io.timeout = 60000; // 60 segundos
    
    // Armazena classes globalmente
    window.WMSLayer = WMSLayer;

    // Define uma classe customizada para o radar CPTEC
    var CPTECRadarLayer = declare([TiledMapServiceLayer], {
      constructor: function(url, options) {
        this.inherited(arguments);
        this._url = url;
        this._options = options;
        this.id = options.id;
        const sr = new SpatialReference({ wkid: 4326 });
        this.spatialReference = sr;
        this.tileInfo = {
          "rows": 256, "cols": 256, "dpi": 96, "format": "PNG32", "compressionQuality": 0,
          "origin": { "x": -180, "y": 90 }, "spatialReference": sr,
          "lods": [
            { "level": 3, "resolution": 0.17578125, "scale": 73874398.264687508 },
            { "level": 4, "resolution": 0.087890625, "scale": 36937199.132343754 },
            { "level": 5, "resolution": 0.0439453125, "scale": 18468599.566171877 },
            { "level": 6, "resolution": 0.02197265625, "scale": 9234299.7830859385 },
            { "level": 7, "resolution": 0.010986328125, "scale": 4617149.8915429693 }
          ]
        };
        const extent = new Extent({
          "xmin": -75.2337, "ymin": -35.7213, "xmax": -27.5977, "ymax": 7.2426,
          "spatialReference": sr
        });
        this.initialExtent = extent;
        this.fullExtent = extent;
        this.opacity = options.opacity || 0.8;
        this.loaded = true;
        this.onLoad(this);
      },
      getTileUrl: function(level, row, col) {
        try {
          const bbox = this._getTileBBox(level, row, col);
          const width = this.tileInfo.cols;
          const height = this.tileInfo.rows;
          const url = this._url +
            "?service=WMS&version=1.1.1&request=GetMap&layers=" + this._options.layerId +
            "&styles=&bbox=" + bbox + "&width=" + width + "&height=" + height +
            "&srs=EPSG:4326&format=image/png&transparent=true&time=" + new Date().getTime();
          console.log("üîç Requisitando tile:", { level, row, col, bbox, url });
          return url;
        } catch (err) {
          console.error("‚ùå Erro ao gerar URL do tile:", err);
          return "";
        }
      },
      _getTileBBox: function(level, row, col) {
        try {
          const resolution = this.tileInfo.lods[level - 3].resolution;
          const tileWidth = this.tileInfo.cols * resolution;
          const tileHeight = this.tileInfo.rows * resolution;
          const minx = Math.max(-180, col * tileWidth - 180);
          const maxy = Math.min(90, 90 - row * tileHeight);
          const maxx = Math.min(180, minx + tileWidth);
          const miny = Math.max(-90, maxy - tileHeight);
          return [minx.toFixed(6), miny.toFixed(6), maxx.toFixed(6), maxy.toFixed(6)].join(",");
        } catch (err) {
          console.error("‚ùå Erro ao calcular BBOX:", err);
          return "-75.233700,-35.721300,-27.597700,7.242600";
        }
      }
    });

    window.addCPTECRadar = function(radarId, type) {
      const layerId = window.CPTEC_LAYERS[type][radarId];
      if (window.cptecLayers?.[layerId]) window.map.removeLayer(window.cptecLayers[layerId]);
      try {
        const layer = new CPTECRadarLayer("http://radar.cptec.inpe.br/geoserver/wms", { id: layerId, layerId: layerId, opacity: 0.8 });
        layer.on("error", (error) => console.error("‚ùå Erro camada radar:", error));
        if (!window.cptecLayers) window.cptecLayers = {};
        window.cptecLayers[layerId] = layer;
        window.map.addLayer(layer);
        console.log(`‚úÖ Camada ${layerId} adicionada`);
      } catch (err) {
        console.error(`‚ùå Erro ao adicionar camada ${layerId}:`, err);
      }
    };

    window.WMSLayer = WMSLayer;
    window.Extent = Extent;
    window.map = new Map("mapDiv", { basemap: "topo", center: [-49.5, -24.75], zoom: 6, sliderStyle: "small" });
    window.imageOverlay = null;
    window.currentImageURL = null;

    const editToolbar = new edit(window.map);
    const relatosLayer = new esri.layers.GraphicsLayer({ id: "relatosLayer" });
    if (!window.map.getLayer("relatosLayer")) window.map.addLayer(relatosLayer);
    window.relatosLayer = relatosLayer;
    let radarLayer = null;

    fetch('https://api.rainviewer.com/public/weather-maps.json')
      .then(res => res.json())
      .then(data => {
        const host = data.host;
        const frames = [...(data.radar.past || []), ...(data.radar.nowcast || [])];
        if (!frames.length) return;
        const latest = frames[frames.length - 1];
        const path = latest.path;
        const urlTemplate = `${host}${path}/256/{level}/{col}/{row}/5/0_0.png`;
        radarLayer = new WebTiledLayer(urlTemplate, { id: "rainviewer", visible: false, copyright: "RainViewer" });
        window.map.addLayer(radarLayer);
      }).catch(err => console.error('‚ùå Erro RainViewer:', err));

    window.map.on("mouse-move", (evt) => {
      if (evt && evt.mapPoint) document.getElementById("hudOverlay").innerHTML = `üìç ${evt.mapPoint.x.toFixed(5)}, ${evt.mapPoint.y.toFixed(5)}¬∞`;
    });

    window.map.on("load", function() {
        console.log("üó∫Ô∏è Mapa carregado, inicializando componentes...");
        try {
            if (typeof window.addCPTECControls === 'function') window.addCPTECControls();
            
            // REMOVE WIDGETS
            // new Legend({ map: window.map }, "legendDiv").startup();
            // new BasemapGallery({ showArcGISBasemaps: true, map: window.map }, "basemapGalleryDiv").startup();
            // new OverviewMap({ map: window.map, visible: true }, "overviewMapDiv").startup();
            // new HomeButton({ map: window.map }, "homeButtonDiv").startup();
            // new Print({ map: window.map, url: "..." }, "printDiv").startup();
            
            updateRiskLegend();
            window.initModalButtons();
            
            // Adiciona Scalebar
            const scalebar = new Scalebar({ map: window.map, scalebarUnit: "dual" });
            
            console.log("‚úÖ Componentes do mapa inicializados");
        } catch (err) {
            console.error("‚ùå Erro ao inicializar componentes:", err);
        }
    });

    fetch("https://cdn.jsdelivr.net/gh/LucasMouraChaser/brasilunificado@main/brasilunificado.geojson")
      .then(res => res.json())
      .then(data => {
        const firstValid = data.features.find(f => f.geometry?.type === "Polygon" || f.geometry?.type === "MultiPolygon");
        if (!firstValid) throw new Error("‚ùå Nenhum pol√≠gono v√°lido no GeoJSON");
        brazilBoundary = firstValid;
        brazilBoundaryReady = true;
        console.log("‚úÖ Contorno do Brasil carregado via jsDelivr");
      }).catch(err => console.error("‚ùå Erro ao carregar contorno do Brasil:", err));

    const catColor = { 0: "#00FF00", 1: "#FFFF00", 2: "#FFA500", 3: "#FF0000", 4: "#800080" };

    fetch("https://cdn.jsdelivr.net/gh/LucasMouraChaser/simplaoosmunicipio@bb3e7071319f8e42ffd24513873ffb73cce566e6/brazil-mun.simplao.geojson")
      .then(res => res.json())
      .then(data => {
        const municipioGraphics = data.features.map(f => new Graphic(
          new Polygon({ rings: f.geometry.coordinates, spatialReference: { wkid: 4326 } }),
          new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0, 0, 0, 0.3]), 1), null)
        ));
        const featureLayer = new esri.layers.GraphicsLayer({ id: "municipios" });
        municipioGraphics.forEach(g => featureLayer.add(g));
        window.map.addLayer(featureLayer);
        featureLayer.setVisibility(false);
        window.municipiosLayer = featureLayer;
        console.log("‚úÖ Munic√≠pios carregados");
      });
      
    function levelOf(prob, type) { return type === 'tornado' ? {2:1, 5:2, 10:3, 15:4}[prob] || 0 : {5:1, 15:2, 30:3, 45:4}[prob] || 0; }
    function clearForecastPolygons() { forecastGraphics.forEach(g => window.map.graphics.remove(g)); forecastGraphics = []; }
    const polygonGroups = { hail: [], wind: [], tornado: [] };

    window.setForecastView = function(mode) {
      forecastMode = mode;
      document.getElementById("choiceDlg").style.display = "none";
      clearForecastPolygons();
      const dateISO = document.getElementById("startDate").value || new Date().toISOString().slice(0, 10);
      const hazard = mode === "all" ? document.getElementById("hazardSel").value : "*";
      window.parent.postMessage({ action: "requestForecast", data: { dateISO, hazard } }, "*");
    };

    function carregarRelatosPorData(dateISO) {
      fetch(`https://www.brazilstormchase.com.br/teste/_functions/reports/list?date=${dateISO}`)
        .then(res => res.json())
        .then(data => {
          if (!data.features || !data.features.length) { relatosLayer.clear(); return; }
          relatosLayer.clear();
          data.features.forEach(f => {
            const [lon, lat] = f.geometry.coordinates;
            const pt = new Point(lon, lat, new SpatialReference({ wkid: 4326 }));
            const symbol = getIconSymbol(f.properties.hazard, f.properties.sev);
            relatosLayer.add(new Graphic(pt, symbol, f.properties));
          });
        }).catch(err => console.error("‚ùå Erro ao buscar relatos:", err));
    }

    function getIconSymbol(hazard, sev = "NOR") {
      const key = `${hazard.toLowerCase()}|${(sev || "NOR").toUpperCase()}`;
      const iconMap = {
        'vento|NOR': 'https://static.wixstatic.com/media/c003a9_38c6ec164e3742dab2237816e4ff8c95~mv2.png',
        'vento|SS': 'https://static.wixstatic.com/media/c003a9_3fc6c303cb364c5db3595e4203c1888e~mv2.png',
        'granizo|NOR': 'https://static.wixstatic.com/media/c003a9_70be04c630a64abca49711a423da779b~mv2.png',
        'granizo|SS': 'https://static.wixstatic.com/media/c003a9_946684b74c234c2287a153a6b6c077fe~mv2.png',
        'tornado|NOR': 'https://static.wixstatic.com/media/c003a9_9f22188e065e4424a1f8ee3a3afeffde~mv2.png',
        'tornado|SS': 'https://static.wixstatic.com/media/c003a9_3a647b1160024b55bb3ecc148df1309f~mv2.png'
      };
      return new esri.symbol.PictureMarkerSymbol(iconMap[key] || iconMap['vento|NOR'], 20, 20);
    }

    window.resetMap = function () {
      window.map.setExtent(new Extent({ xmin: -60.5, ymin: -33.0, xmax: -38.5, ymax: -16.5, spatialReference: { wkid: 4326 } }));
    };

    var damageLayer = new ArcGISDynamicMapServiceLayer("https://services.dat.noaa.gov/arcgis/rest/services/nws_damageassessmenttoolkit/DamageViewer/MapServer", { id: "damageLayer", opacity: 0.7, visible: true });
    window.map.addLayer(damageLayer);
    damageLayer.setVisibleLayers([0,1,2]);

    document.getElementById("searchInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        fetch("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?SingleLine=" + encodeURIComponent(this.value.trim()) + "&f=json")
          .then(res => res.json())
          .then(data => {
            if (!data.candidates || data.candidates.length === 0) return;
            var best = data.candidates[0];
            var pt = new Point(best.location.x, best.location.y, new SpatialReference({ wkid: 4326 }));
            window.map.centerAndZoom(pt, 12);
            // Marker logic ommited for brevity
          });
      }
    });

    window.toggleFullscreen = function () {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => alert("Erro tela cheia."));
      else document.exitFullscreen();
    };

    var drawToolbar = new Draw(window.map);
    drawToolbar.on("draw-complete", function(evt) {
        drawToolbar.deactivate(); window.isDrawing = false;
        if (!brazilBoundary) { alert("‚è≥ Limites do Brasil carregando..."); return; }
        const geom4326 = webMercatorUtils.webMercatorToGeographic(evt.geometry);
        const turfPolygon = { type: "Feature", geometry: { type: "Polygon", coordinates: geom4326.rings.map(ring => ring.map(([x, y]) => [x, y])) } };
        const clipped = turf.intersect(turfPolygon, brazilBoundary);
        if (!clipped) { alert("‚ö†Ô∏è Apenas para o Brasil."); return; }
        
        const hazard = document.getElementById("hazardSel").value, prob = +document.getElementById("probSel").value, level = levelOf(prob, hazard), color = catColor[level] || "#888";
        const symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color(color), 2), new Color([...hexToRgb(color), 0.25]));
        const clippedGraphic = new Graphic(new Polygon({ rings: clipped.geometry.coordinates, spatialReference: { wkid: 4326 } }), symbol);
        clippedGraphic.setAttributes({ hazard, level, prob });
        polygonGroups[hazard].push(clippedGraphic);
        window.map.graphics.add(clippedGraphic);
    });

    window.activatePolygonDraw = function () {
      if (!brazilBoundaryReady) { alert("‚è≥ Limites do Brasil carregando..."); return; }
      window.isDrawing = true;
      drawToolbar.activate(Draw.POLYGON);
    };

    function updateProbabilities() {
      const hazard = document.getElementById("hazardSel").value;
      document.getElementById("probSel").innerHTML = ({ hail:[5,15,30,45], wind:[5,15,30,45], tornado:[2,5,10,15] }[hazard] || []).map(p => `<option value="${p}">${p}</option>`).join('');
    }
    updateProbabilities();
    document.getElementById("hazardSel").addEventListener("change", function () {
      updateProbabilities(); updateRiskLegend();
    });

    function updateRiskLegend() {
      const type = document.getElementById("hazardSel").value;
      const probs = ({ hail:[5,15,30,45], wind:[5,15,30,45], tornado:[2,5,10,15] }[type] || []);
      document.getElementById("legendItems").innerHTML = probs.map(p => {
        const lvl = levelOf(p, type), color = catColor[lvl] || "#999";
        return `<div><span style="display:inline-block;width:14px;height:14px;background:${color};margin-right:6px;border-radius:2px;"></span>${p}% (N√≠vel ${lvl})</div>`;
      }).join('');
    }
    function hexToRgb(hex) { return [parseInt(hex.slice(1, 3), 16), parseInt(hex.slice(3, 5), 16), parseInt(hex.slice(5, 7), 16)]; }

    document.getElementById("toggleRainviewer").addEventListener("change", function(e) { if (radarLayer) radarLayer.setVisibility(e.target.checked); });
    document.getElementById("toggleMunicipios").addEventListener("change", function(e) { if (window.municipiosLayer) window.municipiosLayer.setVisibility(e.target.checked); });
    document.getElementById("btnSubmitForecast").addEventListener("click", () => {
        const dateISO = document.getElementById("startDate").value || new Date().toISOString().slice(0, 10);
        if (!currentUser?.email) { alert("‚ö†Ô∏è Fa√ßa login para enviar."); return; }
        const fc = { type: "FeatureCollection", features: [] };
        Object.entries(polygonGroups).forEach(([hazard, group]) => group.forEach(g => fc.features.push({ type: "Feature", geometry: { type: "Polygon", coordinates: g.geometry.toJson().rings }, properties: { type: hazard, level: g.attributes?.level || 0, prob: g.attributes?.prob || 0 } })));
        if (!fc.features.length) { alert("‚ö†Ô∏è Nenhum pol√≠gono desenhado."); return; }
        const payload = { action: "saveForecast", data: { dateISO, dayType: "hoje", geojson: fc, memberId: currentUser.memberId, nick: currentUser.nick, email: currentUser.email } };
        window.parent.postMessage(JSON.stringify(payload), "*");
    });

    document.getElementById("chkForecastView").addEventListener("change", function (e) {
        if (e.target.checked) document.getElementById("choiceDlg").style.display = "block";
        else { clearForecastPolygons(); }
    });

    window.addEventListener("message", function (evt) {
      const msg = evt.data;
      if(msg.action === "reportsData") { /* logic ommited */ }
      if (msg.action === "deliverForecast") { /* logic ommited */ }
    });
    
    function safeInitialize() {
      const ids = ["geoImageInput", "coordModal", "toggleRainviewer", "toggleMunicipios", "toggleOverlaysBtn", "overlayControls"];
      if (ids.some(id => !document.getElementById(id))) { setTimeout(safeInitialize, 100); return; }
      try {
        const input = document.getElementById("geoImageInput");
        if (input && !input.hasEventListener) { input.addEventListener("change", handleFileSelect); input.hasEventListener = true; }
        window.initModalButtons();
        
        // NOVO: Handler para o bot√£o de sobreposi√ß√µes
        const toggleBtn = document.getElementById("toggleOverlaysBtn");
        const overlayControls = document.getElementById("overlayControls");
        toggleBtn.addEventListener("click", () => {
            const isVisible = overlayControls.style.display === 'block';
            overlayControls.style.display = isVisible ? 'none' : 'block';
        });
        
        // Adiciona controles do CPTEC dinamicamente
        window.addCPTECControls();
        
      } catch (err) { console.error("‚ùå Erro na inicializa√ß√£o:", err); }
    }
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", safeInitialize);
    else safeInitialize();
    
    window.CPTEC_LAYERS = {
        PPI: { SANTIAGO: "radar:santiago_ppi_latest", MORRO_DA_IGREJA: "radar:mdi_ppi_latest", CANGUCU: "radar:cng_ppi_latest", CHAPECO: "radar:chp_ppi_latest" },
        DOPPLER: { SANTIAGO: "radar:santiago_doppler_latest", MORRO_DA_IGREJA: "radar:mdi_doppler_latest", CANGUCU: "radar:cng_doppler_latest", CHAPECO: "radar:chp_doppler_latest" }
    };
    window.addCPTECRadar = function(radarId, type) { /* ... */ };
    window.removeCPTECRadar = function(radarId, type) { /* ... */ };
    window.addCPTECControls = function() {
      const overlayControls = document.getElementById("overlayControls");
      if (overlayControls && !document.getElementById("cptecControls")) {
        const div = document.createElement("div");
        div.id = "cptecControls";
        div.className = "radar-controls";
        div.innerHTML = `
          <h4>Radares CPTEC</h4>
          <div class="radar-group"><h5>Santiago</h5><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('SANTIAGO', 'PPI') : window.removeCPTECRadar('SANTIAGO', 'PPI')"> PPI</label><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('SANTIAGO', 'DOPPLER') : window.removeCPTECRadar('SANTIAGO', 'DOPPLER')"> Doppler</label></div>
          <div class="radar-group"><h5>Morro da Igreja</h5><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('MORRO_DA_IGREJA', 'PPI') : window.removeCPTECRadar('MORRO_DA_IGREJA', 'PPI')"> PPI</label><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('MORRO_DA_IGREJA', 'DOPPLER') : window.removeCPTECRadar('MORRO_DA_IGREJA', 'DOPPLER')"> Doppler</label></div>
          <div class="radar-group"><h5>Cangu√ßu</h5><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('CANGUCU', 'PPI') : window.removeCPTECRadar('CANGUCU', 'PPI')"> PPI</label><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('CANGUCU', 'DOPPLER') : window.removeCPTECRadar('CANGUCU', 'DOPPLER')"> Doppler</label></div>
          <div class="radar-group"><h5>Chapec√≥</h5><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('CHAPECO', 'PPI') : window.removeCPTECRadar('CHAPECO', 'PPI')"> PPI</label><label><input type="checkbox" onchange="this.checked ? window.addCPTECRadar('CHAPECO', 'DOPPLER') : window.removeCPTECRadar('CHAPECO', 'DOPPLER')"> Doppler</label></div>
        `;
        overlayControls.appendChild(div);
      }
    }
  });
  </script>
</body>
</html>
