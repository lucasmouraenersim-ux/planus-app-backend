<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Tempo Severo no Hemisf√©rio Sul</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- ArcGIS API CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/3.35/esri/css/esri.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.35/dijit/themes/claro/claro.css">

  <style>
    html, body {
      width:100%; height:100%; margin:0; padding:0; overflow:hidden;
    }
    #mapDiv {
      width:100%; height:100%;
    }

    .section { margin-bottom:20px; }
    .section h3 { margin:0 0 8px 0; font-family:Segoe UI, sans-serif; color:#1f4059; }
    #layersDiv input { margin-right:4px; }
    .esriPrint { margin-top:10px; }

    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #003366; color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px; z-index: 1000;
    }
    #topbar .left { display: flex; align-items: center; gap: 10px; }
    #topbar .left img { height: 30px; }
    #topbar .left h1 { font-size: 18px; margin: 0; }
    #topbar input[type="text"] {
      padding: 6px; font-size: 14px; width: 250px;
    }
    #topbar .right { display: flex; align-items: center; gap: 8px; }
    .top-btn {
      background: none; border: none; color: white;
      font-size: 20px; cursor: pointer;
      padding: 4px;
    }
    .top-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    .date-controls {
      display: flex; align-items: center; gap: 4px;
    }
    .date-controls input[type="date"] {
      padding: 3px 6px; font-size: 13px;
    }
    .date-controls .date-btn {
      background: #0066cc; color: white; border: none;
      padding: 4px 8px; font-size: 13px; border-radius: 3px;
      cursor: pointer;
    }

    #customTools {
      position: fixed;
      top: 150px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #customTools button {
      width: 32px;
      height: 32px;
      background: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      box-shadow: 0 0 3px rgba(0,0,0,0.2);
    }
    #customTools button:hover {
      background: #eee;
    }

    /* Modal Forecast */
    #forecastModal {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:300px; background:#fff;
      padding:20px;
      border:1px solid #ccc;
      border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      z-index:99999;
      font-family:sans-serif;
    }
    #forecastModal h3 { margin-top:0; }
    #forecastModal select {
      width: 100%;
      padding: 6px;
      margin-top: 8px;
    }
    #forecastModal button {
      margin-top: 12px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #forecastModal .cancel { background: #ccc; }
    #forecastModal .save { background: #0066cc; color: white; margin-left: 10px; }

    /* Modal de Coordenadas */
    #coordModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 10000;
      width: 300px;
    }
    #coordModal input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #coordModal button {
      margin-top: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #coordModal .save {
      background: #0066cc;
      color: white;
    }
    #coordModal .cancel {
      background: #ccc;
      margin-right: 10px;
    }

    #riskControls {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 1000;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-family: sans-serif;
    }
    .risk-options {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #overlayHeader {
        cursor: pointer;
        padding-top: 8px;
        margin-top: 8px;
        border-top: 1px solid #555;
    }
    #overlayHeader b::after {
        content: ' ‚ñº';
        font-size: 10px;
        display: inline-block;
        margin-left: 5px;
    }
    #overlayHeader.collapsed b::after {
        content: ' ‚ñ∂';
    }
    #overlayContent {
        padding-top: 8px;
        max-height: 300px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
     #overlayContent.collapsed {
        max-height: 0;
        padding-top: 0;
        overflow: hidden;
    }

    #overlayControls input[type="range"] {
      width: 100px;
      margin-top: 5px;
    }

    .radar-controls {
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      color: #333;
    }
    .radar-controls h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    .radar-controls h5 {
      margin: 5px 0;
      font-size: 13px;
    }
    .radar-group {
      margin-bottom: 10px;
    }
    .radar-group label {
      display: inline-block;
      margin-right: 10px;
      font-size: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-spinner {
        border: 4px solid #f3f3f3; 
        border-top: 4px solid #00cfff; 
        border-radius: 50%;
        width: 60px; height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    .loading-text {
        font-family: Arial, sans-serif;
        font-size: 24px;
        color: white;
    }

    /* Estilo para tela cheia */
    :fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      background: white;
    }

    /* Suporte para diferentes navegadores */
    :-webkit-full-screen {
      width: 100vw !important;
      height: 100vh !important;
      background: white;
    }
    :-moz-full-screen {
      width: 100vw !important;
      height: 100vh !important;
      background: white;
    }
    :-ms-fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      background: white;
    }
  </style>

  <!-- ArcGIS API -->
  <script src="https://js.arcgis.com/3.35/"></script>
</head>

<body class="claro">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 51, 102, 0.95); display: flex; justify-content: center; align-items: center; z-index: 99999;">
      <div style="text-align: center;">
          <div class="loading-spinner"></div>
          <div class="loading-text">Carregando...</div>
      </div>
  </div>

  <script>
    function forceFullscreen() {
        const elem = document.documentElement;
        try {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            }
        } catch (err) {
            console.warn("‚ö†Ô∏è N√£o foi poss√≠vel ativar tela cheia:", err);
        }
    }

    window.addEventListener('load', function() {
        setTimeout(function() {
            var loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.opacity = '0';
            loadingOverlay.style.transition = 'opacity 1s';
            setTimeout(function() {
                loadingOverlay.style.display = 'none';
                // forceFullscreen(); // A tela cheia autom√°tica pode ser bloqueada, melhor ser iniciada pelo usu√°rio.
            }, 1000);
        }, 3000); // Reduzido para 3 segundos
    });
  </script>

  <input type="file" id="geoImageInput" accept=".jpg,.jpeg,.png,.tif,.tiff" style="display:none">

  <div id="topbar">
    <div class="left">
      <h1>Tempo Severo no Hemisf√©rio Sul</h1>
      <input type="text" id="searchInput" placeholder="Buscar endere√ßo ou local..." />
    </div>

    <div class="right">
      <button class="top-btn" id="btn-search" title="Filtro">üîç</button>
      <button class="top-btn" id="btn-add-data" title="Adicionar Dados">‚ûï</button>
      <button class="top-btn" id="btn-legend" title="Legenda">üìã</button>
      <button class="top-btn" onclick="resetMap()" title="Resetar Visualiza√ß√£o">üîÑ</button>
      <button class="top-btn" onclick="triggerImageUpload()" title="Carregar Imagem de Sat√©lite">üñºÔ∏è</button>
      <button class="date-btn" id="btnSubmitForecast">Enviar previs√£o</button>
      <div class="date-controls">
        <label>De: <input type="date" id="startDate" /></label>
        <label>At√©: <input type="date" id="endDate" /></label>
        <button class="date-btn" id="submitDate">Buscar</button>
        <button class="date-btn" id="resetDate">Resetar</button>
      </div>
    </div>
  </div>

  <div id="riskControls">
      <div class="risk-options">
        <label>Tipo:
            <select id="hazardSel">
            <option value="hail">Granizo</option>
            <option value="wind">Vento</option>
            <option value="tornado">Tornado</option>
            </select>
        </label>
        <label>Prob(%):
            <select id="probSel"></select>
        </label>
        <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="chkForecastView">
            <span>Ver previs√£o feita</span>
        </label>
      </div>
      <div id="overlayControls">
          <div id="overlayHeader"><b>Sobreposi√ß√µes</b></div>
          <div id="overlayContent" class="collapsed">
            <label><input type="checkbox" id="toggleRainviewer"> Radar (RainViewer)</label><br>
            <label><input type="checkbox" id="toggleMunicipios"> Munic√≠pios</label><br>
            <div id="imageControls" style="display: none;">
                <label><input type="checkbox" id="toggleOverlay"> Mostrar Imagem</label><br>
                <div id="opacityControl" style="margin-left: 20px; display: none;">
                    Opacidade: <span id="opacityValue">100%</span><br>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100" style="width: 100%;">
                </div>
            </div>
            <div id="cptecControlsContainer"></div>
          </div>
      </div>
  </div>

  <div id="legendPrevots" style="display: none; position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 10px 14px; font-size: 13px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); font-family: sans-serif; z-index: 9999;">
      <b>N√≠veis PREVOTS</b>
      <div>
        <div><span style="display:inline-block;width:14px;height:14px;background:#00FF00;margin-right:6px;border-radius:2px;"></span>PREV 1</div>
        <div><span style="display:inline-block;width:14px;height:14px;background:#FFFF00;margin-right:6px;border-radius:2px;"></span>PREV 2</div>
        <div><span style="display:inline-block;width:14px;height:14px;background:#FFA500;margin-right:6px;border-radius:2px;"></span>PREV 3</div>
        <div><span style="display:inline-block;width:14px;height:14px;background:#FF0000;margin-right:6px;border-radius:2px;"></span>PREV 4</div>
      </div>
  </div>

  <div id="customTools">
    <button onclick="toggleFullscreen()" title="Tela Cheia">‚õ∂</button>
    <button onclick="activatePolygonDraw()" title="Desenhar Pol√≠gono">‚¨¢</button>
  </div>

  <div id="mapDiv"></div>
  
  <div id="legendRisk" style="position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 10px 14px; font-size: 13px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); font-family: sans-serif; z-index: 9999;">
    <b>Legenda por risco</b>
    <div id="legendItems"></div>
  </div>

  <div id="hudOverlay" style="position: fixed; bottom: 8px; left: 20px; background: rgba(0,0,0,0.7); color: white; font-family: monospace; font-size: 12px; padding: 4px 8px; border-radius: 4px; z-index: 1000; pointer-events: none;">
    üìç --,-- ¬∞
  </div>

  <div id="statsPanel" style="position: fixed; bottom: 180px; right: 20px; background: rgba(255,255,255,0.95); padding: 10px 14px; font-size: 13px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); font-family: sans-serif; z-index: 1000;">
    <div id="statsContent">Carregando...</div>
  </div>

  <!-- Modal para salvar previs√£o -->
  <div id="forecastModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:300px; background:#fff; padding:20px; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.2); z-index:99999; font-family:sans-serif;">
    <h3>Salvar Previs√£o</h3>
    <label>Dia:
      <select id="dayType">
        <option value="hoje">Hoje</option>
        <option value="amanh√£">Amanh√£</option>
      </select>
    </label>
    <br><br>
    <button class="cancel" onclick="cancelForecast()">Cancelar</button>
    <button class="save" onclick="confirmForecast()">Salvar</button>
  </div>

  <!-- Modal de escolha -->
  <div id="choiceDlg" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #262626; color: white; border: 1px solid #999; border-radius: 6px; padding: 16px 20px; font-family: sans-serif; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.6); z-index: 10000;">
    <div style="margin-bottom: 10px">O que deseja visualizar?</div>
    <button onclick="setForecastView('all')">Todos os riscos</button>
    <button onclick="setForecastView('overall')">Mapa geral</button>
  </div>

  <!-- Modal de Coordenadas -->
  <div id="coordModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000; width: 300px;">
    <h3>Coordenadas da Imagem</h3>
    <div style="margin-bottom: 15px;">
      <button id="btnAutoLoad" class="auto-load" style="width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">
        Carregar Automaticamente
      </button>
      <div style="text-align: center; color: #666; margin: 5px 0;">- ou -</div>
      <div style="text-align: center; color: #666; font-size: 12px;">Ajuste as coordenadas manualmente:</div>
    </div>
    <label>Longitude M√≠nima (Oeste):<br>
      <input type="number" id="lonMin" step="0.000001" value="-60.503571">
    </label><br>
    <label>Longitude M√°xima (Leste):<br>
      <input type="number" id="lonMax" step="0.000001" value="-38.495731">
    </label><br>
    <label>Latitude M√≠nima (Sul):<br>
      <input type="number" id="latMin" step="0.000001" value="-33.002845">
    </label><br>
    <label>Latitude M√°xima (Norte):<br>
      <input type="number" id="latMax" step="0.000001" value="-16.497153">
    </label><br>
    <button id="btnCancelLoad" class="cancel">Cancelar</button>
    <button id="btnLoadCoords" class="save">Carregar Manual</button>
  </div>

  <script>
  let forecastGraphics = [];
  let forecastMode = "all"; // "all" ou "overall"
  let brazilBoundary = null;
  let brazilBoundaryReady = false;

  let currentUser = null;

  window.addEventListener("message", (e) => {
    const msg = e.data;
    try {
      const parsed = typeof msg === "string" ? JSON.parse(msg) : msg;
      if (parsed?.loggedIn) {
        currentUser = { email: parsed.email, nick: parsed.nick || parsed.email?.split("@")[0], memberId: parsed.memberId || null };
        console.log("‚úÖ Usu√°rio logado:", currentUser);
      }
    } catch (err) {
      console.warn("üîÅ Mensagem n√£o era JSON parse√°vel:", err);
    }
  });

  setTimeout(() => {
    if (!currentUser) {
      currentUser = { email: "anon@local", nick: "visitante", memberId: null };
      console.warn("‚ö†Ô∏è Modo visitante");
    }
  }, 3000);

  function triggerImageUpload() {
    const input = document.getElementById("geoImageInput");
    if (!input) return;
    if (!input.hasEventListener) {
      input.addEventListener("change", handleFileSelect);
      input.hasEventListener = true;
    }
    input.click();
  }
  
  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    const validTypes = ['image/jpeg', 'image/png', 'image/tiff'];
    if (!validTypes.includes(file.type)) {
      alert("Por favor, selecione uma imagem nos formatos: JPG, PNG ou TIFF");
      return;
    }
    const reader = new FileReader();
    reader.onload = function(evt) {
      window.currentImageURL = evt.target.result;
      document.getElementById("coordModal").style.display = "block";
      initModalButtons();
    };
    reader.readAsDataURL(file);
  }

  require([
    "esri/map", "esri/geometry/Polygon", "esri/geometry/webMercatorUtils", "esri/geometry/Extent",
    "esri/dijit/HomeButton", "esri/layers/WebTiledLayer", "esri/layers/WMSLayer", "esri/layers/TiledMapServiceLayer",
    "esri/toolbars/edit", "esri/dijit/Print", "esri/dijit/Legend", "esri/dijit/BasemapGallery",
    "esri/dijit/OverviewMap", "esri/dijit/TimeSlider", "esri/dijit/Scalebar", "esri/layers/ArcGISDynamicMapServiceLayer",
    "esri/geometry/Point", "esri/SpatialReference", "esri/symbols/SimpleMarkerSymbol", "esri/symbols/SimpleLineSymbol",
    "esri/symbols/SimpleFillSymbol", "esri/Color", "esri/graphic", "esri/toolbars/draw",
    "esri/layers/MapImage", "esri/layers/MapImageLayer", "esri/config", "dojo/dom", "dojo/on",
    "dojo/dom-construct", "dojo/_base/declare", "dojo/domReady!"
  ], function(
    Map, Polygon, webMercatorUtils, Extent, HomeButton, WebTiledLayer, WMSLayer,
    TiledMapServiceLayer, edit, Print, Legend, BasemapGallery, OverviewMap, TimeSlider,
    Scalebar, ArcGISDynamicMapServiceLayer, Point, SpatialReference,
    SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,
    Color, Graphic, Draw, MapImage, MapImageLayer, esriConfig,
    dom, on, domConstruct, declare
  ) {
    esriConfig.defaults.io.corsEnabledServers.push("radar.cptec.inpe.br", "http://radar.cptec.inpe.br", "https://radar.cptec.inpe.br");
    esriConfig.defaults.io.alwaysUseProxy = false;
    esriConfig.defaults.io.corsDetection = false;
    esriConfig.defaults.io.useCors = false;
    esriConfig.defaults.io.postMixInProperties = function() { this.protocol = window.location.protocol; };
    esriConfig.defaults.io.timeout = 60000;

    window.map = new Map("mapDiv", { basemap: "topo", center: [-49.5, -24.75], zoom: 6, sliderStyle: "small" });
    window.imageOverlay = null;
    window.currentImageURL = null;
    const editToolbar = new edit(window.map);
    const relatosLayer = new esri.layers.GraphicsLayer({ id: "relatosLayer" });
    if (!window.map.getLayer("relatosLayer")) { window.map.addLayer(relatosLayer); }
    window.relatosLayer = relatosLayer;
    let radarLayer = null;

    fetch('https://api.rainviewer.com/public/weather-maps.json')
      .then(res => res.json())
      .then(data => {
        const host = data.host;
        const frames = [...(data.radar.past || []), ...(data.radar.nowcast || [])];
        if (!frames.length) return;
        const latest = frames[frames.length - 1];
        const urlTemplate = `${host}${latest.path}/256/{level}/{col}/{row}/5/0_0.png`;
        radarLayer = new WebTiledLayer(urlTemplate, { id: "rainviewer", visible: false, copyright: "RainViewer" });
        window.map.addLayer(radarLayer);
      }).catch(err => console.error('‚ùå Erro ao carregar RainViewer:', err));
    
    window.map.on("mouse-move", function(evt) {
      if (evt && evt.mapPoint) {
        document.getElementById("hudOverlay").innerHTML = `üìç ${evt.mapPoint.x.toFixed(5)}, ${evt.mapPoint.y.toFixed(5)}¬∞`;
      }
    });

    const scalebarDiv = document.createElement("div");
    scalebarDiv.style.cssText = `position: fixed; bottom: 80px; left: 20px; background: rgba(255,255,255,0.9); padding: 4px 10px; font-family: sans-serif; font-size: 11px; border-radius: 4px; box-shadow: 0 0 4px rgba(0,0,0,0.2); z-index: 1000;`;
    document.body.appendChild(scalebarDiv);
    new Scalebar({ map: window.map, scalebarUnit: "dual", attachTo: "bottom-left" }, scalebarDiv);

    window.map.on("load", function() {
        if (typeof window.addCPTECControls === 'function') { window.addCPTECControls(); }
        new HomeButton({ map: window.map }, domConstruct.create("div", null, dom.byId("customTools"), "first")).startup();
        updateRiskLegend();
    });

    fetch("https://cdn.jsdelivr.net/gh/LucasMouraChaser/brasilunificado@main/brasilunificado.geojson")
      .then(res => res.json())
      .then(data => {
        const firstValid = data.features.find(f => f.geometry?.type === "Polygon" || f.geometry?.type === "MultiPolygon");
        if (!firstValid) throw new Error("‚ùå Nenhum pol√≠gono v√°lido no GeoJSON");
        brazilBoundary = firstValid;
        brazilBoundaryReady = true;
      }).catch(err => console.error("‚ùå Erro ao carregar contorno do Brasil:", err));

    const catColor = { 0: "#00FF00", 1: "#FFFF00", 2: "#FFA500", 3: "#FF0000", 4: "#800080" };

    fetch("https://cdn.jsdelivr.net/gh/LucasMouraChaser/simplaoosmunicipio@bb3e7071319f8e42ffd24513873ffb73cce566e6/brazil-mun.simplao.geojson")
      .then(res => res.json())
      .then(data => {
        const municipioGraphics = data.features.map(f => new Graphic(
          new Polygon({ rings: f.geometry.coordinates, spatialReference: { wkid: 4326 } }),
          new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0, 0, 0, 0.3]), 1), null)
        ));
        const featureLayer = new esri.layers.GraphicsLayer({ id: "municipios" });
        municipioGraphics.forEach(g => featureLayer.add(g));
        window.map.addLayer(featureLayer);
        featureLayer.setVisibility(false);
        window.municipiosLayer = featureLayer;
      });
      
    function levelOf(prob, type) {
      return type === 'tornado' ? {2:1, 5:2, 10:3, 15:4}[prob] || 0 : {5:1, 15:2, 30:3, 45:4}[prob] || 0;
    }

    function setForecastView(mode) {
      forecastMode = mode;
      document.getElementById("choiceDlg").style.display = "none";
      clearForecastPolygons();
      const legendPrevots = document.getElementById("legendPrevots");
      const legendRisk = document.getElementById("legendRisk");
      legendPrevots.style.display = mode === "overall" ? "block" : "none";
      legendRisk.style.display = mode !== "overall" ? "block" : "none";
      const dateISO = document.getElementById("startDate").value || new Date().toISOString().slice(0, 10);
      window.parent.postMessage({ action: "requestForecast", data: { dateISO } }, "*");
    }

    window.setForecastView = function(mode) {
      forecastMode = mode;
      document.getElementById("choiceDlg").style.display = "none";
      clearForecastPolygons();
      const dateISO = document.getElementById("startDate").value || new Date().toISOString().slice(0, 10);
      const hazard = mode === "all" ? document.getElementById("hazardSel").value : "*";
      window.parent.postMessage({ action: "requestForecast", data: { dateISO, hazard } }, "*");
    };

    function renderForecastPolygons(fc) {
      clearForecastPolygons();
      if (!fc?.features?.length) return;
      if (forecastMode === "overall") {
        const merged = turf.union(...fc.features);
        if (!merged) return;
        const rings = merged.geometry.coordinates[0];
        const polygon = new Polygon({ rings, spatialReference: { wkid: 4326 } });
        const symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#00cfff"), 2), new Color([0, 207, 255, 0.3]));
        const graphic = new Graphic(polygon, symbol);
        window.map.graphics.add(graphic);
        forecastGraphics.push(graphic);
        return;
      }
      fc.features.forEach(f => {
        if (f.geometry?.type !== "Polygon") return;
        const rings = f.geometry.coordinates[0];
        const polygon = new Polygon({ rings, spatialReference: { wkid: 4326 } });
        const hazard = f.properties?.type || "hail";
        const level  = f.properties?.level || 0;
        const color  = catColor[level] || "#999";
        const symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_DIAGONAL_CROSS, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color(color), 2), new Color([...hexToRgb(color), 0.25]));
        const g = new Graphic(polygon, symbol);
        window.map.graphics.add(g);
        forecastGraphics.push(g);
      });
    }

    function clearForecastPolygons() {
      forecastGraphics.forEach(g => window.map.graphics.remove(g));
      forecastGraphics = [];
    }
    const polygonGroups = { hail: [], wind: [], tornado: [] };

    function togglePolygonsByRisk(selected) {
      Object.entries(polygonGroups).forEach(([risk, group]) => {
        group.forEach(g => g.setVisibility(risk === selected));
      });
    }

    function getIconSymbol(hazard, sev = "NOR") {
      const key = `${hazard.toLowerCase()}|${(sev || "NOR").toUpperCase()}`;
      const iconMap = {
        'vento|NOR':   'https://static.wixstatic.com/media/c003a9_38c6ec164e3742dab2237816e4ff8c95~mv2.png',
        'vento|SS':    'https://static.wixstatic.com/media/c003a9_3fc6c303cb364c5db3595e4203c1888e~mv2.png',
        'granizo|NOR': 'https://static.wixstatic.com/media/c003a9_70be04c630a64abca49711a423da779b~mv2.png',
        'granizo|SS':  'https://static.wixstatic.com/media/c003a9_946684b74c234c2287a153a6b6c077fe~mv2.png',
        'tornado|NOR': 'https://static.wixstatic.com/media/c003a9_9f22188e065e4424a1f8ee3a3afeffde~mv2.png',
        'tornado|SS':  'https://static.wixstatic.com/media/c003a9_3a647b1160024b55bb3ecc148df1309f~mv2.png'
      };
      return new esri.symbol.PictureMarkerSymbol(iconMap[key] || iconMap['vento|NOR'], 20, 20);
    }

    window.resetMap = function () {
      window.map.setExtent(new Extent({ xmin: -60.5, ymin: -33.0, xmax: -38.5, ymax: -16.5, spatialReference: { wkid: 4326 } }));
    };

    var damageLayer = new ArcGISDynamicMapServiceLayer("https://services.dat.noaa.gov/arcgis/rest/services/nws_damageassessmenttoolkit/DamageViewer/MapServer", { id: "damageLayer", opacity: 0.7, visible: true });
    window.map.addLayer(damageLayer);
    window.map.on("layers-add-result", function(evt){
      var info = evt.layers[0].layer.timeInfo;
      if (!info) return;
      var slider = new TimeSlider({ style: "width:100%;" }, "timeSliderDiv");
      window.map.setTimeSlider(slider);
      slider.setThumbCount(2);
      slider.createTimeStopsByTimeInterval(info.timeExtent, 1, "days");
      slider.setThumbMovingRate(2000);
      slider.startup();
      on(slider, "time-extent-change", function(evt){ damageLayer.setTimeDefinition(evt.startTime, evt.endTime); });
    });
    damageLayer.setVisibleLayers([0,1,2]);

    var searchMarker = null;
    document.getElementById("searchInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        var query = this.value.trim();
        if (!query) return;
        fetch("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?SingleLine=" + encodeURIComponent(query) + "&f=json")
          .then(res => res.json()).then(data => {
            if (!data.candidates || data.candidates.length === 0) { alert("‚ùå Nenhum endere√ßo encontrado."); return; }
            var best = data.candidates[0];
            var pt = new Point(best.location.x, best.location.y, new SpatialReference({ wkid: 4326 }));
            window.map.centerAndZoom(pt, 12);
            if (searchMarker) window.map.graphics.remove(searchMarker);
            var symbol = new SimpleMarkerSymbol().setColor(new Color([255, 0, 0, 0.75])).setSize(12).setOutline(new SimpleLineSymbol().setColor(new Color([255,255,255])));
            var graphic = new Graphic(pt, symbol);
            window.map.graphics.add(graphic);
            searchMarker = graphic;
            setTimeout(() => {
              window.map.infoWindow.setTitle("Resultado");
              window.map.infoWindow.setContent(best.address);
              window.map.infoWindow.show(pt);
            }, 300);
          });
      }
    });

    window.toggleFullscreen = function () {
      const el = document.documentElement;
      if (!document.fullscreenElement) { el.requestFullscreen().catch(err => alert("Erro ao entrar em tela cheia.")); } else { document.exitFullscreen(); }
    };

    var drawToolbar = new Draw(window.map);
    let isDrawing = false;
    drawToolbar.on("draw-complete", function(evt) {
      drawToolbar.deactivate();
      isDrawing = false;
      if (!brazilBoundary) { alert("‚è≥ Contorno do Brasil ainda n√£o est√° pronto."); return; }
      const geom4326 = webMercatorUtils.webMercatorToGeographic(evt.geometry);
      const turfPolygon = { type: "Feature", geometry: { type: "Polygon", coordinates: geom4326.rings.map(ring => ring.map(([x, y]) => [parseFloat(x), parseFloat(y)])) }, properties: {} };
      const clipped = turf.intersect(turfPolygon, brazilBoundary);
      if (!clipped) { alert("‚ö†Ô∏è Previs√£o √© feita apenas para o Brasil."); return; }
      const hazard = document.getElementById("hazardSel").value;
      const prob = +document.getElementById("probSel").value;
      const level = levelOf(prob, hazard);
      const color = catColor[level] || "#888";
      const symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color(color), 2), new Color([...hexToRgb(color), 0.25]));
      const clippedGraphic = new Graphic(new Polygon({ rings: clipped.geometry.coordinates, spatialReference: { wkid: 4326 } }), symbol);
      clippedGraphic.setAttributes({ hazard, level, prob });
      if (!polygonGroups[hazard]) polygonGroups[hazard] = [];
      polygonGroups[hazard].push(clippedGraphic);
      window.map.graphics.add(clippedGraphic);
    });

    window.activatePolygonDraw = function () {
      if (!brazilBoundaryReady) { alert("‚è≥ Aguarde: limites do Brasil ainda est√£o carregando..."); return; }
      isDrawing = true;
      drawToolbar.activate(Draw.POLYGON);
    };

    window.cancelForecast = () => document.getElementById("forecastModal").style.display = "none";
    window.confirmForecast = function () {
      const dateISO = new Date().toISOString().slice(0,10);
      const dayType = document.getElementById("dayType").value;
      const features = Object.values(polygonGroups).flat().map(g => ({ type: "Feature", geometry: g.geometry.toJson(), properties: g.attributes }));
      if (!features.length) { alert("‚ö†Ô∏è Nenhum pol√≠gono desenhado."); return; }
      const message = { action: "saveForecast", data: { dateISO, dayType, geojson: { type: "FeatureCollection", features } } };
      window.parent.postMessage(JSON.stringify(message), "*");
      document.getElementById("forecastModal").style.display = "none";
    };

    function updateProbabilities() {
      const hazard = document.getElementById("hazardSel").value;
      const probs = { hail:[5,15,30,45], wind:[5,15,30,45], tornado:[2,5,10,15] }[hazard];
      document.getElementById("probSel").innerHTML = probs.map(p => `<option value="${p}">${p}</option>`).join('');
    }
    updateProbabilities();
    document.getElementById("hazardSel").addEventListener("change", function () {
      updateProbabilities();
      updateRiskLegend();
      togglePolygonsByRisk(this.value);
    });

    function updateRiskLegend() {
      const type = document.getElementById("hazardSel").value;
      const probs = { hail: [5,15,30,45], wind: [5,15,30,45], tornado: [2,5,10,15] }[type] || [];
      document.getElementById("legendItems").innerHTML = probs.map(p => {
        const lvl = levelOf(p, type);
        const color = catColor[lvl] || "#999";
        return `<div><span style="display:inline-block;width:14px;height:14px;background:${color};margin-right:6px;border-radius:2px;"></span>${p}% (N√≠vel ${lvl})</div>`;
      }).join('');
    }

    function hexToRgb(hex) {
      hex = hex.replace("#", "");
      return [ parseInt(hex.substring(0,2), 16), parseInt(hex.substring(2,4), 16), parseInt(hex.substring(4,6), 16) ];
    }
    document.getElementById("toggleRainviewer").addEventListener("change", e => radarLayer?.setVisibility(e.target.checked));
    document.getElementById("toggleMunicipios").addEventListener("change", e => window.municipiosLayer?.setVisibility(e.target.checked));
    document.getElementById("submitDate").addEventListener("click", () => {
      const dateISO = document.getElementById("startDate").value;
      if (dateISO) window.parent.postMessage({ action: "fetchReports", data: { dateISO } }, "*");
    });
    document.getElementById("btnSubmitForecast").addEventListener("click", () => document.getElementById("forecastModal").style.display = "block");
    document.getElementById("chkForecastView").addEventListener("change", e => {
      if (e.target.checked) { document.getElementById("choiceDlg").style.display = "block"; }
      else { clearForecastPolygons(); document.getElementById("legendPrevots").style.display = "none"; document.getElementById("legendRisk").style.display = "block"; }
    });

    window.addEventListener("message", function (evt) {
      const msg = evt.data;
      if (msg.action === "reportsData") {
        const features = msg.data?.features || [];
        if (!window.relatosLayer) return;
        const stats = { total: 0, sig: 0, hail: 0, wind: 0, tornado: 0, hailSig: 0, windSig: 0, tornadoSig: 0 };
        relatosLayer.clear();
        features.forEach(f => {
          const [lon, lat] = f.geometry.coordinates;
          const props = f.properties || {};
          const hazard = props.hazard?.toLowerCase() || "desconhecido";
          const sev = props.sev || "N/A";
          stats.total++; if (sev === 'SS') stats.sig++;
          if (hazard === 'granizo') { stats.hail++; if (sev === 'SS') stats.hailSig++; }
          if (hazard === 'vento') { stats.wind++; if (sev === 'SS') stats.windSig++; }
          if (hazard === 'tornado') { stats.tornado++; if (sev === 'SS') stats.tornadoSig++; }
          const pt = new Point(lon, lat, new SpatialReference({ wkid: 4326 }));
          const symbol = getIconSymbol(hazard, sev);
          const g = new Graphic(pt, symbol, props);
          g.setInfoTemplate(new esri.InfoTemplate(props.hazard?.toUpperCase() || 'Relato', `<b>Tipo:</b> ${props.hazard || 'N/A'}<br><b>Severidade:</b> ${sev}<br><b>Hora:</b> ${props.hora || 'N/A'}<br><b>Lat:</b> ${pt.getLatitude().toFixed(4)}<br><b>Lon:</b> ${pt.getLongitude().toFixed(4)}`));
          relatosLayer.add(g);
        });
        document.getElementById("statsContent").innerHTML = `<b>Total:</b> ${stats.total} (<b>${stats.sig}</b> sig)<br><span style="color:#3366cc"><b>Vento:</b> ${stats.wind} (${stats.windSig} sig)</span><br><span style="color:#33aa33"><b>Granizo:</b> ${stats.hail} (${stats.hailSig} sig)</span><br><span style="color:#cc0033"><b>Tornado:</b> ${stats.tornado} (${stats.tornadoSig} sig)</span>`;
      }
      if (msg.action === "deliverForecast") {
        const fc = msg.geojson;
        if (!fc || !Array.isArray(fc.features)) return;
        if (forecastMode === "overall") {
          const merged = turf.union(...fc.features);
          if (!merged) return;
          const rings = merged.geometry.coordinates[0];
          const polygon = new Polygon({ rings, spatialReference: { wkid: 4326 } });
          const symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#00cfff"), 2), new Color([0, 207, 255, 0.3]));
          const graphic = new Graphic(polygon, symbol);
          window.map.graphics.add(graphic);
          forecastGraphics.push(graphic);
        } else {
          const label = document.getElementById("hazardSel").value;
          const selected = { granizo: "hail", vento: "wind", tornado: "tornado" }[label] || label;
          const filtered = fc.features.filter(f => f.properties?.type?.toLowerCase() === selected.toLowerCase());
          if (!filtered.length) return;
          renderForecastPolygons({ type: "FeatureCollection", features: filtered });
        }
      }
    });
    window.parent.postMessage({ action: "ready" }, "*");

    function safeInitialize() {
      const requiredElements = [ "geoImageInput", "coordModal", "toggleRainviewer", "toggleMunicipios" ];
      if (requiredElements.some(id => !document.getElementById(id))) { setTimeout(safeInitialize, 100); return; }
      initModalButtons();
      const input = document.getElementById("geoImageInput");
      if (input && !input.hasEventListener) { input.addEventListener("change", handleFileSelect); input.hasEventListener = true; }
      const overlayHeader = document.getElementById('overlayHeader');
      const overlayContent = document.getElementById('overlayContent');
      if (overlayHeader && overlayContent) {
          overlayHeader.addEventListener('click', () => {
              overlayContent.classList.toggle('collapsed');
              overlayHeader.classList.toggle('collapsed');
          });
      }
      const cptecContainer = document.getElementById('cptecControlsContainer');
      if (typeof window.addCPTECControls === 'function') { window.addCPTECControls(cptecContainer); }

    }
    document.addEventListener("DOMContentLoaded", safeInitialize);

  });
  </script>
</body>
</html>