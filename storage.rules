
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions to keep rules clean and readable
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      // Allow specific superadmin emails to bypass Firestore read for initial setup
      let isSuperAdminEmail = request.auth.token.email == 'lucasmoura@sentenergia.com' || request.auth.token.email == 'eduardo.w@sentenergia.com';
      // Check for admin/superadmin role in Firestore, only if the user document exists
      let isFirestoreAdmin = exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
                             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'admin' ||
                              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'superadmin');
      return isSuperAdminEmail || isFirestoreAdmin;
    }

    function isLeadOwner(leadId) {
      // Check if user is authenticated and the lead document exists, then check ownership.
      return isAuth() && 
             exists(/databases/$(database)/documents/crm_leads/$(leadId)) &&
             get(/databases/$(database)/documents/crm_leads/$(leadId)).data.userId == request.auth.uid;
    }

    // Profile photos: Allow users to read/write their own photos. Admins can access any.
    match /profile_photos/{userId}/{allPaths=**} {
      allow read, write: if isAuth() && (request.auth.uid == userId || isAdmin());
    }

    // Lead documents (consolidated)
    match /crm_lead_documents/{leadId}/{allPaths=**} {
      allow read, write: if isAuth() && (isLeadOwner(leadId) || isAdmin());
    }
    
    // Feedback attachments
    match /crm_lead_feedback/{leadId}/{allPaths=**} {
      allow read, write: if isAuth() && (isLeadOwner(leadId) || isAdmin());
    }
    
    // Chat media
    match /chat_media/{leadId}/{allPaths=**} {
      allow read, write: if isAuth() && (isLeadOwner(leadId) || isAdmin());
    }

    // Public files (e.g., for WhatsApp templates)
    match /public/{allPaths=**} {
      allow get; // Allow public read access
      allow write: if isAdmin(); // Only admins can write
    }
  }
}
