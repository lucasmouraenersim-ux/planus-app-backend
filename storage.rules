rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions to keep rules clean and readable
    function isAuth() {
      return request.auth != null;
    }

    function isRole(role) {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == role;
    }

    function isAdmin() {
      // Allow specific superadmin emails to bypass Firestore read for initial setup
      let isSuperAdminEmail = request.auth.token.email == 'lucasmoura@sentenergia.com' || request.auth.token.email == 'eduardo.w@sentenergia.com';
      // Check for admin/superadmin role in Firestore
      let isAdminRole = isAuth() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'superadmin'
      );
      return isSuperAdminEmail || isAdminRole;
    }

    function isLeadOwner(leadId) {
      return isAuth() && 
             exists(/databases/$(database)/documents/crm_leads/$(leadId)) &&
             get(/databases/$(database)/documents/crm_leads/$(leadId)).data.userId == request.auth.uid;
    }

    // Profile photos: Allow users to read/write their own photos. Admins can access any.
    match /profile_photos/{userId}/{allPaths=**} {
      allow read, write: if isAuth() && (request.auth.uid == userId || isAdmin());
    }

    // Lead-related documents: Allow the lead's assigned seller or an admin to read/write.
    // This rule covers documents, bills, and other lead-specific files.
    match /crm_lead_documents/{leadId}/{allPaths=**} {
      allow read, write: if isAuth() && (isLeadOwner(leadId) || isAdmin());
    }
    
    // Feedback attachments: Same permissions as other lead documents.
    // A seller can only upload feedback for a lead that is assigned to them.
    match /crm_lead_feedback/{leadId}/{allPaths=**} {
      allow read, write: if isAuth() && (isLeadOwner(leadId) || isAdmin());
    }
    
    // Allow public read for any files in a 'public' folder (e.g., for WhatsApp templates)
    // Only admins can write to this folder.
    match /public/{allPaths=**} {
      allow get;
      allow write: if isAdmin();
    }

    // Default deny all other paths
  }
}