rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check user role
    function isUserRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == role;
    }
    function isSignedIn() {
      return request.auth != null;
    }

    // Users can read their own profile. Admins can do anything.
    // Users can update their own profile.
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list, create, delete: if isUserRole('admin');
      allow update: if isUserRole('admin') || (isSignedIn() && request.auth.uid == userId);
    }

    // Leads can be read by their assigned seller or any admin.
    // Creation is restricted to authenticated users.
    // Unauthenticated access (like WhatsApp webhooks) MUST be handled by the Admin SDK in backend flows.
    match /crm_leads/{leadId} {
      allow get: if isUserRole('admin') || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow list: if isUserRole('admin') || isUserRole('vendedor');
      allow create: if isUserRole('admin') || (isUserRole('vendedor') && request.resource.data.userId == request.auth.uid);
      allow update: if isUserRole('admin') || (isUserRole('vendedor') && resource.data.userId == request.auth.uid);
      allow delete: if isUserRole('admin');
    }

    // Chat history can only be accessed along with the corresponding lead.
    // Unauthenticated access (like WhatsApp webhooks) MUST be handled by the Admin SDK.
    match /crm_lead_chats/{leadId} {
      allow read, write: if isUserRole('admin') || (
        isSignedIn() &&
        exists(/databases/$(database)/documents/crm_leads/$(leadId)) &&
        get(/databases/$(database)/documents/crm_leads/$(leadId)).data.userId == request.auth.uid
      );
    }

    // Withdrawal requests can be created by the user for themselves.
    // Only admins can view the list or update/delete requests.
    match /withdrawal_requests/{requestId} {
      allow get: if isUserRole('admin') || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow list, update, delete: if isUserRole('admin');
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
  }
}
